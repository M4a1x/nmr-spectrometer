\setchapterpreamble[u]{\margintoc}
\chapter{Introduction}
\labch{intro}

\section{Concept}
Idea/motivation
given magnet
schema of setup
Design decisions
rf switch
amplifiers

\section{Complete Setup}

\begin{circuitikz}[european]
	\ctikzset{bipoles/amp/width=0.9}
	\draw[nodes={align=center}]
	(0,0) coordinate(mid)

	% TX
	(mid) ++(0,3) node[draw, align=center, minimum height=5.5cm, minimum width=2cm](decoder){Sequence\\Decoder}
	($(decoder.east)!0.75!(decoder.north east)$) coordinate(decoderi)
	($(decoder.east)!0.75!(decoder.south east)$) coordinate(decoderq)
	($(decoder.north west)!0.5!(decoder.south west)$) coordinate(decoderin)
	(decoderin) ++(-1,0) node[left]{Pulse\\Sequence} coordinate(seq) -- (decoderin) node[inputarrow]{}
	(decoderi) node[left]{I} ++(3,0) node[mixer](mi1){}
	(decoderq) node[left]{Q} ++(3,0) node[mixer](mq1){}
	(decoderi) -- (mi1.w) node[inputarrow]{}
	(decoderq) -- (mq1.w) node[inputarrow]{}
	(decoderin -| mi1.s) coordinate (center1)
	(center1) ++(-1,0) node[oscillator](osc1){} -- (center1) -- (mi1.s) node[inputarrow,rotate=90]{}
	(osc1.n) node[above]{NCO}
	(osc1.s) node[below]{\qty{25}{MHz}}
	(center1) to[phaseshifter,>,l=90°] (mq1.n) node[inputarrow,rotate=270]{}
	(center1) ++(2,0) node[adder](add1){}
	(mi1.e) -| (add1.n) node[inputarrow,rotate=270]{}
	(mq1.e) -| (add1.s) node[inputarrow,rotate=90]{}
	(add1.e) to[dac,>] ++(2,0) to[amp,t=PA,l=Power\\Amplifier,>] ++(2,0) coordinate(tx)

	% Circulator
	(mid -| tx) node[circulator](circ){} node[below right]{passive\\TX/RX Switch}
	(tx) -| (circ.n) node[inputarrow,rotate=270]{}

	% RX
	(mid) ++(0,-3) coordinate(center_rx)
	(center_rx -| circ) coordinate(rx_out)
	(circ.s) |- (rx_out)
	(rx_out) to[amp,t=\rotatebox{180}{LNA},l=Low Noise\\Amplifier,>] ++(-2,0) to[adc,>] ++(-2,0) -- (rx_out -| add1) coordinate(rx_split)
	(rx_split) ++(0,2) coordinate(rx_upper)
	(rx_split) ++(0,-2) coordinate(rx_lower)
	(rx_upper -| mi1) node[mixer](mi2){}
	(rx_lower -| mq1) node[mixer](mq2){}
	(rx_split) |- (mi2.e) node[inputarrow,rotate=180]{}
	(rx_split) |- (mq2.e) node[inputarrow,rotate=180]{}
	(rx_split -| osc1) node[oscillator](osc2){}
	(osc2.n) node[above]{NCO}
	(osc2.s) node[below]{\qty{25}{MHz}}
	(osc2.e) -| (mi2.s) node[inputarrow,rotate=90]{}
	(osc2.e -| mq2) to[phaseshifter,>,l=90°] (mq2.n) node[inputarrow,rotate=270]{}
	(mi2.w) to[bandpass,l_=CIC,>] (mi2 -| decoderi) node[inputarrow,rotate=180]{} node[left](circ_out_i){I}
	(circ_out_i) -- (mi2 -| seq) node[left]{I} node[inputarrow,rotate=180]{}
	(mq2.w) to[bandpass,l=CIC,>] (mq2 -| decoderq) node[inputarrow,rotate=180]{} node[left](circ_out_q){Q}
	(circ_out_q) -- (mq2 -| seq) node[left]{Q} node[inputarrow,rotate=180]{}

	% Probe
	(circ.e) -- ++(2,0) node[dinantenna](probe){Probe}
	;

	% Red Pitaya
	\draw[dashed]
	($(seq)!0.5!(decoderin)$) ++(0,3) coordinate(rectangle_start)
	($(add1.e)!0.5!(tx)$) coordinate(rp_out)
	(rp_out |- mq2) ++(0,-1) coordinate(rectangle_end)
	(rectangle_start) rectangle (rectangle_end)
	(rectangle_start) node[above right]{Red Pitaya}
	;
\end{circuitikz}