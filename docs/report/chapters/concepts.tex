\setchapterpreamble[u]{%
    \margintoc\hfil%
    \dictum[Oscar Wilde]{You can never be\\overdressed or overeducated.}
}
\chapter{Concepts}
\labch{concepts}

This chapter will quickly introduce the topics the reader is expected to be familiar with going into the thesis. It aims to be a quick reminder of the most important formulas and concepts without going into any depth. A full introduction to chemistry, \acrshort{nmr}, electronics and \acrshort{rf} engineering is outside the scope of this text. For a better introduction than the author will ever be capable of, please take a look at other literature, such as \enquote{Spin Dynamics}\sidecite{levittSpinDynamicsBasics2008a}, \enquote{Experimental Pulse NMR}\sidecite{fukushimaExperimentalPulseNMR2019}, \enquote{Halbleiter-Schaltungstechnik}\sidecite{tietzeHalbleiterSchaltungstechnik2019} and \enquote{The Art of Electronics}\sidecite{horowitzArtElectronics2022}.

\section{NMR Spectroscopy}
Simply put, a nucleus of an \enquote{NMR active}\sidenote{For example \ch{^1H}, \ch{^{13}C}, \ch{^{19}F}, \ldots} atom will absorb and then later emit radio waves at a specific frequency that depends on an external magnetic field -- the stronger the field the higher the frequency:

\[
    \omega = \gamma{}B_0
\]

The specific frequency \(\omega\) is usually called the \emph{Larmor frequency}. \(\gamma\) is called the \emph{gyromagnetic ratio} and depends on the atom. Finally, \(B_0\) is the name for the external static magnetic field produced by a large magnet\sidenote{As opposed to \(B_1\) which is the magnetic component of the radio wave.}.

Nature now has it, that the exact frequency that the nuclei \emph{resonante} with depends on their surroundings. Inversely, we can thus exploit this property to figure out these surroundings if we know the frequency at which the nuclei resonate. \emph{Surroundings} include for example whether an atom is located next to another atom only in space due to some folding of a long molecule or whether a chemical bond is present as well.

Thus we need to send radio waves at multiple frequencies and then look at the corresponding return signals. To speed this process up, we can send all frequencies we're interested in at the same time using so-called \acrshort{ftnmr}.

\todo{bring the above and below paragraphs together}


Nuclear Magnetic Resonance is the fundamental principle describing the effect that atomic nuclei absorb radio waves at a certain frequency when exposed to an external magnetic field. This phenomenon is called \enquote{resonance}. The magnetic dipole moment \(\vec{\mu}\) can be but in relation with the quantum spin number \(\vec{S}\) through the gyromagnetic ratio \(\gamma\) --- which is a constant property of a given nucleus --- with the relation
\[
    \vec{\mu} = \gamma\vec{S}
\]
Atomic nuclei with both an even number of protons and neutrons do not show this effect, because their spin is zero and they have no nuclear magnetic dipole moment, which can be easily verified with the equation above. Examples of nuclei that are so-called \enquote{NMR active} include \ch{}

Placed inside an external magnetic field we call \(B_0\) and excited with the right frequency radio wave the total spin magnetization will start precessing around the external magnetic field \(B_0\) according to the relation
\[
    \omega = -\gamma{}B_0
\]
where \(\gamma\) is again the gyromagnetic ratio and \(\omega = 2\pi{}f\) with \(f\) being the precession frequency. This precession can be observed when the excitation radio wave stops and we listen for radio waves emitted by the nuclei as they relax from their excited state back to their previous state. Because the resonant frequency is also dependent on the surroundings\sidenote{For example couplings inside the molecule} of the atom, structural, chemical and physical analysis can be performed by measuring this shift of expected resonance frequency to the observed. Chemists call this shift in frequency the \enquote{Chemical Shift (CS)}.

The conceptually simplest method of NMR spectroscopy would be to send an \enquote{infinitely} long\sidenote{In practice just \emph{very} long} radio wave with a slowly changing frequency to find the exact frequencies that the nuclei resonate at. This technique is called \acrlong{cwnmr} or short \acrshort{cwnmr}.

The Fourier theorem states that any periodic signal can be written as a sum of pure sinus waves. In practice, any time signal can be viewed as periodic with a period of infinity. The process of decomposing a signal into its sine components is called Fourier Transform (FT)\sidenote{In practice, a specific algorithm called Fast Fourier Transform (FFT) is used. If it is performed on discrete values (e.g. arrays of data), it is often called DFFT for Discrete Fast Fourier Transform}. The other way around --- composing a signal by summing up pure sine waves --- is called inverse Fourier Transform or iFT.

The concept of Fourier Transformation can then be used to very easily send multiple frequencies at once. This concept is called pulsed NMR or FT-NMR. The simplest pulse is a multiplication of a rectangle signal (see the left side of \reffig{rect}) with a simple pure sine wave (see the left side of \reffig{sine-inf}) with a frequency close to the suspected resonance frequency. In practice, this simply means quickly switching the transmission of the sine wave on and off (see the left side of \reffig{fig:sine-pulse}). Because a single rectangle pulse consists of many frequencies (right side of \reffig{rect}), only a single pulse of a sine wave close to the relevant resonant frequency is needed to excite multiple nuclei with slightly different resonance frequencies (see \reffig{sine-inf} and \reffig{sine-pulse})\sidenote{A multiplication of the time domain signals results in a convolution in the frequency domain}. The shorter the pulse, the more frequencies can be excited, but less energy is transmitted in total and per frequency.
\begin{figure}[tbh]
    \includesvg{images/pulse_fft/1s_rect_pulse_fft.svg}
    \caption{A rectangle window function of length \qty{1}{\second} in time domain with an amplitude of 1 on the left side and its Fourier transform on the right side, capped to \(\pm{}\qty{10}{\hertz}\)}
    \labfig{rect}
\end{figure}

\begin{figure}[tbh]
    \includesvg{images/pulse_fft/20hz_inf_fft.svg}
    \caption{An infinite sine wave of \qty{20}{\hertz} plotted from \qty{-1}{\second} to \qty{1}{\second} on the left side and its Fourier Transform on the right}
    \labfig{sine-inf}
\end{figure}

\begin{figure}[tbh]
    \includesvg{images/pulse_fft/20hz_1s_pulse_fft.svg}
    \caption{A pulsed sine wave of \qty{20}{\hertz} and a pulse length of \qty{1}{\second} plotted from \qty{-1}{\second} to \qty{1}{\second} on the left side and its Fourier Transform on the right. Notice the broadening in the centre compared to the pure sine wave in \reffig{sine-inf}. We are sending multiple frequencies around \qty{20}{\hertz} at the same time simply by pulsing a single frequency sine wave.}
    \labfig{sine-pulse}
\end{figure}

Mention z-plane orientation vs xy plane measurement

TODO: Introduce formulas needed for rf pulse amplifier output power calculation

Principles of Pulses and relaxation
rotating reference frame
different variatns: continuous wave, pulse, CIDNP, ...
different goals: structure, chemical shifts, J coupling/electron bonds/...
!requirements on homogenity, noise, coil, rf, ...





\section{RF-Engineering}
Q/I Modulation
superheterodyne/homodyne/direct sampling receiver
oversampling vs undersampling?
reflection coefficient
wave propagation


\section{Concept}
Idea/motivation
given magnet
schema of setup
Design decisions
rf switch
amplifiers

\section{Complete Setup}

\begin{figure*}
    \centering
    \begin{circuitikz}[european]
        \ctikzset{bipoles/amp/width=0.9}
        \draw[nodes={align=center}]
        (0,0) coordinate(mid)

        % TX
        (mid) ++(0,3) node[draw, align=center, minimum height=5.5cm, minimum width=2cm](decoder){Sequence\\Decoder}
        ($(decoder.east)!0.75!(decoder.north east)$) coordinate(decoderi)
        ($(decoder.east)!0.75!(decoder.south east)$) coordinate(decoderq)
        ($(decoder.north west)!0.5!(decoder.south west)$) coordinate(decoderin)
        (decoderin) ++(-1,0) node[left]{Pulse\\Sequence} coordinate(seq) -- (decoderin) node[inputarrow]{}
        (decoderi) node[left]{I} ++(3,0) node[mixer](mi1){}
        (decoderq) node[left]{Q} ++(3,0) node[mixer](mq1){}
        (decoderi) -- (mi1.w) node[inputarrow]{}
        (decoderq) -- (mq1.w) node[inputarrow]{}
        (decoderin -| mi1.s) coordinate (center1)
        (center1) ++(-1,0) node[oscillator](osc1){} -- (center1) -- (mi1.s) node[inputarrow,rotate=90]{}
        (osc1.n) node[above]{NCO}
        (osc1.s) node[below]{\qty{25}{MHz}}
        (center1) to[phaseshifter,>,l=90°] (mq1.n) node[inputarrow,rotate=270]{}
        (center1) ++(2,0) node[adder](add1){}
        (mi1.e) -| (add1.n) node[inputarrow,rotate=270]{}
        (mq1.e) -| (add1.s) node[inputarrow,rotate=90]{}
        (add1.e) to[dac,>] ++(2,0) to[amp,t=PA,l=Power\\Amplifier,>] ++(2,0) coordinate(tx)

        % Circulator
        (mid -| tx) node[circulator](circ){} node[below right]{active\\TX/RX Switch}
        (tx) -| (circ.n) node[inputarrow,rotate=270]{}

        % RX
        (mid) ++(0,-3) coordinate(center_rx)
        (center_rx -| circ) coordinate(rx_out)
        (circ.s) |- (rx_out)
        (rx_out) to[amp,t=\rotatebox{180}{LNA},l=Low Noise\\Amplifier,>] ++(-2,0) to[adc,>] ++(-2,0) -- (rx_out -| add1) coordinate(rx_split)
        (rx_split) ++(0,2) coordinate(rx_upper)
        (rx_split) ++(0,-2) coordinate(rx_lower)
        (rx_upper -| mi1) node[mixer](mi2){}
        (rx_lower -| mq1) node[mixer](mq2){}
        (rx_split) |- (mi2.e) node[inputarrow,rotate=180]{}
        (rx_split) |- (mq2.e) node[inputarrow,rotate=180]{}
        (rx_split -| osc1) node[oscillator](osc2){}
        (osc2.n) node[above]{NCO}
        (osc2.s) node[below]{\qty{25}{MHz}}
        (osc2.e) -| (mi2.s) node[inputarrow,rotate=90]{}
        (osc2.e -| mq2) to[phaseshifter,>,l=90°] (mq2.n) node[inputarrow,rotate=270]{}
        (mi2.w) to[bandpass,l_=CIC,>] (mi2 -| decoderi) node[inputarrow,rotate=180]{} node[left](circ_out_i){I}
        (circ_out_i) -- (mi2 -| seq) node[left]{I} node[inputarrow,rotate=180]{}
        (mq2.w) to[bandpass,l=CIC,>] (mq2 -| decoderq) node[inputarrow,rotate=180]{} node[left](circ_out_q){Q}
        (circ_out_q) -- (mq2 -| seq) node[left]{Q} node[inputarrow,rotate=180]{}

        % Probe
        (circ.e) -- ++(2,0) node[dinantenna](probe){Probe}
        ;

        % Red Pitaya
        \draw[dashed]
        ($(seq)!0.5!(decoderin)$) ++(0,3) coordinate(rectangle_start)
        ($(add1.e)!0.5!(tx)$) coordinate(rp_out)
        (rp_out |- mq2) ++(0,-1) coordinate(rectangle_end)
        (rectangle_start) rectangle (rectangle_end)
        (rectangle_start) node[above right]{Red Pitaya}
        ;
    \end{circuitikz}

    \caption{\captiontitle{The \acrlong{rp} inside the transmit-receive pipeline.} The processing inside the \acrlong{rp} is done digitally on an \acrshort{fpga} before being sent to the high-level control software.}
    \labfig{redpitaya}
\end{figure*}
