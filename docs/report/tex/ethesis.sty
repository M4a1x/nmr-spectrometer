\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ethesis}[2023/11/18 ETH Zurich Thesis package collection]

% Require LuaTex and fail early if another engine is used
\RequirePackage{iftex}
\RequireLuaTeX{}

\RequirePackage{kvoptions}
\SetupKeyvalOptions{
    family=ETH,
    prefix=ETH@
} % user shorter prefix ETH (instead of ethesis)
%\DeclareStringOption[initial (always set)]{keyname}[default (aka. default value if key is provided)]
\DeclareBoolOption{debug}
\DeclareStringOption[english]{language}  % Passed to polyglossia, e.g. english or german
\DeclareDefaultOption{%
    \ifx\CurrentOptionValue\relax
    \PackageWarningNoLine{\@currname}{
        Unknown option '\CurrentOption'\MessageBreak
    }
    % Pass through any option (overwriting defaults) and load it
    \expandafter\PassOptionsToClass{\expandafter\CurrentOption}{\@baseclass}
}
\ProcessKeyvalOptions*

% Print warning on unknown option
% \DeclareOption*{\PackageWarning{examplepackage}{Unknown '\CurrentOption'}}
% \ProcessOptions\relax  % Execute above options

\RequirePackage[\ETH@language]{tracklang}  % Language Tracking, i.e. what has polyglossia been requested to use?


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Debug
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ifETH@debug
    \RequirePackage{showframe} 	% Shows boxes around the text area, margin, header and footer
    \RequirePackage{showlabels} % Output the content of \label commands to the document where they are used
    \KOMAoptions{draft=true}		% Print markers for overfull boxes/lines
\fi


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Typography and Misc.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{scrhack}	% Fix packages incompatible with KOMA features
\RequirePackage{etoolbox}  	% Programming facilities
\RequirePackage{import}		% Relative path imports
\RequirePackage{pdflscape} 	% Pages in landscape format

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Colour
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Load this before unicode-math font specifications to make colors available there
\RequirePackage{xcolor}

% ETH color scheme
% https://ethz.ch/staffnet/en/service/communication/corporate-design/farbe.html

% ETH Blue
\definecolor{blue}{HTML}{215CAF}
\definecolor{blue8}{HTML}{4D7DBF}
\definecolor{blue6}{HTML}{7A9DCF}
\definecolor{blue4}{HTML}{A6BEDF}
\definecolor{blue2}{HTML}{D3DEEF}
\definecolor{blue1}{HTML}{E9EFF7}
\definecolor{blued}{HTML}{08407E}

% ETH Petrol
\definecolor{petrol}{HTML}{007894}
\definecolor{petrol8}{HTML}{3395AB}
\definecolor{petrol6}{HTML}{66AFC0}
\definecolor{petrol4}{HTML}{99CAD5}
\definecolor{petrol2}{HTML}{CCE4EA}
\definecolor{petrol1}{HTML}{E7F4F7}
\definecolor{petrold}{HTML}{00596D}

% ETH Green
\definecolor{green}{HTML}{627313}
\definecolor{green8}{HTML}{818F42}
\definecolor{green6}{HTML}{A1AB71}
\definecolor{green4}{HTML}{C0C7A1}
\definecolor{green2}{HTML}{E0E3D0}
\definecolor{green1}{HTML}{EFF1E7}
\definecolor{greend}{HTML}{365213}

% ETH Bronze
\definecolor{bronze}{HTML}{8E6713}
\definecolor{bronze8}{HTML}{A58542}
\definecolor{bronze6}{HTML}{BBA471}
\definecolor{bronze4}{HTML}{D2C2A1}
\definecolor{bronze2}{HTML}{E8E1D0}
\definecolor{bronze1}{HTML}{F4F0E7}
\definecolor{bronzed}{HTML}{956013}

% ETH Red
\definecolor{red}{HTML}{B7352D}
\definecolor{red8}{HTML}{C55D57}
\definecolor{red6}{HTML}{D48681}
\definecolor{red4}{HTML}{E2AEAB}
\definecolor{red2}{HTML}{F1D7D5}
\definecolor{red1}{HTML}{F8EBEA}
\definecolor{redd}{HTML}{96272D}

% ETH Purple
\definecolor{purple}{HTML}{A30774}
\definecolor{purple8}{HTML}{B73B92}
\definecolor{purple6}{HTML}{CA6CAE}
\definecolor{purple4}{HTML}{DC9EC9}
\definecolor{purple2}{HTML}{EFD0E3}
\definecolor{purple1}{HTML}{F8E8F3}
\definecolor{purpled}{HTML}{8C0A59}

% ETH Grey
\definecolor{grey}{HTML}{6F6F6F}
\definecolor{grey8}{HTML}{8C8C8C}
\definecolor{grey6}{HTML}{A9A9A9}
\definecolor{grey4}{HTML}{C5C5C5}
\definecolor{grey2}{HTML}{E2E2E2}
\definecolor{grey1}{HTML}{F1F1F1}
\definecolor{greyd}{HTML}{575757}

% Use the colors for different things
% Can be redefined by user
\definecolor{blankcolor}{named}{grey8}		% Used for the text on 'blank' pages
\definecolor{chaptercolor}{named}{grey8}	% Used for the big chapter numbers in the title
\definecolor{accentcolor}{named}{redd}  	% Used for accents, e.g. some chapter headings
\definecolor{externallink}{named}{redd} 	% Used for URLs
\definecolor{internallink}{named}{blued}	% Used for links to Figures/Tables/Listings/...
\definecolor{reflink}{named}{greend} 		% Used for links into the bibliography/glossary/index
\definecolor{margincolor}{named}{grey8} 	% Used for the text in the margin
\definecolor{titlecolor}{named}{accentcolor}% Used for the title on the titlepage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document metadata commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \title{}, \subtitle{}, \author{}, \date{}
% See also https://stackoverflow.com/a/2833982

% Logo
\newcommand*{\logo}[1]{%
    \renewcommand*{\@logo}{#1}%
}
\newcommand*{\@logo}{%
    \ClassWarning{ethesis}{No \noexpand\logo given}
}

% Born
\newcommand*{\born}[1]{%
    \renewcommand*{\@born}{#1}%
}
\newcommand*{\@born}{%
    \ClassWarning{ethesis}{No \noexpand\born given}
}

% Citizen
\newcommand*{\citizen}[1]{%
    \renewcommand*{\@citizen}{#1}%
}
\newcommand*{\@citizen}{%
    \ClassWarning{ethesis}{No \noexpand\citizen given}
}

% Examiner
\newcommand*{\examiner}[1]{%
    \renewcommand*{\@examiner}{#1}%
}
\newcommand*{\@examiner}{%
    \ClassWarning{ethesis}{No \noexpand\examiner given}
}

% Supervisor
\newcommand*{\supervisor}[1]{%
    \renewcommand*{\@supervisor}{#1}%
}
\newcommand*{\@supervisor}{%
    \ClassWarning{ethesis}{No \noexpand\supervisor given}
}

% Degree
\newcommand*{\degree}[1]{%
    \renewcommand*{\@degree}{#1}%
}
\newcommand*{\@degree}{%
    \ClassWarning{ethesis}{No \noexpand\degree given}
}

% Degree Shorthand / Abbreviation
\newcommand*{\shortdegree}[1]{%
    \renewcommand*{\@shortdegree}{#1}%
}
\newcommand*{\@shortdegree}{%
    \ClassWarning{ethesis}{No \noexpand\shortdegree given}
}

% Student ID number
\newcommand*{\idnumber}[1]{%
    \renewcommand*{\@idnumber}{#1}%
}
\newcommand*{\@idnumber}{%
    \ClassWarning{ethesis}{No \noexpand\idnumber given}%{\@ehc}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fonts
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{fontspec}  % Requires LuaLaTeX

% Advanced typesetting for kerning etc.
% Enable tracking (i.e. be able to change the added space between letters)
% Does this by default for smallcaps (textsc/scshape)
\RequirePackage{microtype}
\PassOptionsToPackage{tracking=true}{microtype}
\microtypesetup{protrusion=true,expansion=true}  % classicthesis

% Using 'shortcuts' package option, do e.g. 'fast\-/paced' to get a breakable
% 'fast-pace' word in print.
% Otherwise, LaTeX does not hyphenate/linebreak words that already come with a hyphen,
% since that could be ambiguous
\RequirePackage[shortcuts]{extdash}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Deliberately blank pages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Alternative to fancyhdr. KOMA-script for page/header/footer layout
\RequirePackage{scrlayer-scrpage}  % automark headers and footers with current chapter

% https://tex.stackexchange.com/a/205536/120853
\renewcommand*{\blankpage}{
    \par\vspace*{\fill}
    \begin{center}
        \textcolor{blankcolor}{
            This page intentionally left blank.%
            % https://web.archive.org/web/20041119090707/https://www3.epa.gov/ttn/oarpg/t1/memoranda/eipfin.pdf
        }
    \end{center}
    \vspace{\fill}
}

\DeclareNewLayer[%
    foreground,%
    textarea,%
    contents=\blankpage,%
]{blankpage.fg}
\DeclarePageStyleByLayers{blank}{blankpage.fg}
\KOMAoptions{cleardoublepage=blank}